{{- /*
获取文章封面图片
优先级：
1. Front matter 中的 thumbnail
2. Front matter 中的 image
3. 页面资源中的第一张图片（Page Resources）
4. 文章内容中的第一张图片（从 markdown 中提取）
*/ -}}

{{- $thumbnail := "" -}}

{{- /* 1. 优先使用 front matter 中的 thumbnail */ -}}
{{- if .Params.thumbnail -}}
    {{- $thumbnail = .Params.thumbnail -}}
{{- /* 2. 其次使用 front matter 中的 image */ -}}
{{- else if .Params.image -}}
    {{- $thumbnail = .Params.image -}}
{{- /* 3. 尝试从页面资源中获取第一张图片 */ -}}
{{- else -}}
    {{- $images := .Resources.ByType "image" -}}
    {{- if $images -}}
        {{- $firstImage := index $images 0 -}}
        {{- $thumbnail = $firstImage.RelPermalink -}}
    {{- else -}}
        {{- /* 4. 从文章内容中提取第一张图片 URL */ -}}
        {{- $content := .Content -}}
        {{- /* 匹配 markdown 图片: ![alt](url) */ -}}
        {{- $mdImageRegex := `!\[.*?\]\((.*?)\)` -}}
        {{- /* 匹配 HTML 图片: <img src="url"> */ -}}
        {{- $htmlImageRegex := `<img[^>]+src=["']([^"']+)["']` -}}

        {{- /* 先尝试匹配 markdown 图片 */ -}}
        {{- if (findRE $mdImageRegex $content 1) -}}
            {{- $match := index (findRE $mdImageRegex $content 1) 0 -}}
            {{- /* 提取 URL 部分 */ -}}
            {{- $urlMatch := findRE `\((.*?)\)` $match 1 -}}
            {{- if $urlMatch -}}
                {{- $url := index $urlMatch 0 -}}
                {{- $thumbnail = trim (trim $url "(") ")" -}}
            {{- end -}}
        {{- /* 再尝试匹配 HTML 图片 */ -}}
        {{- else if (findRE $htmlImageRegex $content 1) -}}
            {{- $match := index (findRE $htmlImageRegex $content 1) 0 -}}
            {{- /* 提取 src 属性值 */ -}}
            {{- $srcMatch := findRE `src=["']([^"']+)["']` $match 1 -}}
            {{- if $srcMatch -}}
                {{- $src := index $srcMatch 0 -}}
                {{- /* 移除 src=" 和结尾的 " */ -}}
                {{- $thumbnail = replaceRE `^src=["']|["']$` "" $src -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- /* 返回封面图片 URL */ -}}
{{- $thumbnail -}}
